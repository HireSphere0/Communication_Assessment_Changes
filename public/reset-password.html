<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Communication Assessment Suite</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="shortcut icon" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <link rel="stylesheet" href="auth-styles.css">
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="brand">Skill Tesseract</div>
            <nav class="nav-links">
                <a href="/" class="nav-link">Home</a>
            </nav>
        </div>

        <!-- Reset Password Form -->
        <main class="page-band">
            <div class="auth-form">
                <h2>Reset Password</h2>

                <form id="reset-password-form">
                    <div class="form-group">
                        <label for="password">New Password</label>
                        <input type="password" id="password" name="password" required>
                        <div class="password-strength" id="password-strength" style="display: none;">
                            <div class="strength-meter">
                                <div class="strength-fill" id="strength-fill"></div>
                            </div>
                            <div class="strength-text" id="strength-text"></div>
                        </div>
                        <div class="error-message" id="password-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                        <div class="error-message" id="confirmPassword-error"></div>
                        <div class="success-message" id="confirmPassword-success"></div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" id="reset-btn" disabled>
                            <span class="btn-text">Reset Password</span>
                            <div class="loading" id="reset-loading">
                                <div class="spinner"></div>
                            </div>
                        </button>
                    </div>
                    <div class="form-links">
                        <p><a href="/login">Back to Login</a></p>
                    </div>
                </form>
            </div>
        </main>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-inner">
                <div class="footer-brand"><small>&copy; 2025 Skill Tesseract</small></div>
                <nav class="footer-links" aria-label="Footer">
                    <a href="/contact" class="footer-link">Contact us</a>
                    <a href="mailto:mockinterview014@gmail.com" class="footer-link">Email</a>
                    <a href="https://www.linkedin.com/company/skill-tesseract/?viewAsMember=true" target="_blank" rel="noopener" class="footer-link">LinkedIn</a>
                    <a href="https://www.instagram.com/skilltesseract" target="_blank" rel="noopener" class="footer-link">Instagram</a>
                </nav>
            </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="message-container" class="message-container" style="display: none;">
        <div id="message" class="message"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resetForm = document.getElementById('reset-password-form');
            const resetBtn = document.getElementById('reset-btn');
            const resetLoading = document.getElementById('reset-loading');
            const btnText = document.querySelector('.btn-text');

            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                showMessage('Invalid password reset link. Please request a new password reset.', 'error');
                resetBtn.disabled = true;
                return;
            }

            console.log('Token found, form ready for submission');

            // Password strength requirements
            const passwordRequirements = {
                minLength: 8,
                hasUppercase: /[A-Z]/,
                hasLowercase: /[a-z]/,
                hasNumbers: /\d/,
                hasSpecialChar: /[!@#$%^&*(),.?":{}|<>]/
            };

            resetForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Clear previous errors
                clearErrors();
                
                // Get form data
                const formData = new FormData(resetForm);
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');

                // Validation
                let hasErrors = false;

                const passwordStrength = checkPasswordStrength(password);
                if (!password) {
                    showFieldError('password', 'Password is required');
                    hasErrors = true;
                } else if (passwordStrength.score < 3) {
                    showFieldError('password', 'Password is too weak. Please choose a stronger password.');
                    hasErrors = true;
                }

                if (!confirmPassword) {
                    showFieldError('confirmPassword', 'Please confirm your password');
                    hasErrors = true;
                } else if (password !== confirmPassword) {
                    showFieldError('confirmPassword', 'Passwords do not match');
                    hasErrors = true;
                }

                if (hasErrors) return;

                // Show loading state
                setLoadingState(true);

                try {
                    const response = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ token, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage('Password reset successfully! Redirecting to login...', 'success');
                        setTimeout(() => {
                            window.location.href = '/login?message=Password%20reset%20successfully!%20You%20can%20now%20log%20in&type=success';
                        }, 2000);
                    } else {
                        if (data.field) {
                            showFieldError(data.field, data.error);
                        } else {
                            showMessage(data.error || 'Password reset failed. Please try again.', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Reset password error:', error);
                    showMessage('Network error. Please check your connection and try again.', 'error');
                } finally {
                    setLoadingState(false);
                }
            });

            // Real-time validation
            document.getElementById('password').addEventListener('input', function() {
                const password = this.value;
                const strengthContainer = document.getElementById('password-strength');
                
                if (password) {
                    strengthContainer.style.display = 'block';
                    const strength = checkPasswordStrength(password);
                    updatePasswordStrengthUI(strength);
                    
                    if (strength.score >= 3) {
                        this.classList.remove('error');
                        this.classList.add('success');
                        clearFieldError('password');
                    } else {
                        this.classList.remove('success');
                        this.classList.add('error');
                    }
                } else {
                    strengthContainer.style.display = 'none';
                    this.classList.remove('error', 'success');
                    clearFieldError('password');
                }
                
                // Re-validate confirm password
                const confirmPassword = document.getElementById('confirmPassword').value;
                if (confirmPassword) {
                    validateConfirmPassword(password, confirmPassword);
                }
                
                updateSubmitButton();
            });

            document.getElementById('confirmPassword').addEventListener('input', function() {
                const password = document.getElementById('password').value;
                const confirmPassword = this.value;
                
                validateConfirmPassword(password, confirmPassword);
                updateSubmitButton();
            });

            function validateConfirmPassword(password, confirmPassword) {
                const confirmField = document.getElementById('confirmPassword');
                
                if (confirmPassword) {
                    if (password === confirmPassword) {
                        confirmField.classList.remove('error');
                        confirmField.classList.add('success');
                        clearFieldError('confirmPassword');
                        showFieldSuccess('confirmPassword', 'Passwords match');
                    } else {
                        confirmField.classList.remove('success');
                        confirmField.classList.add('error');
                        clearFieldSuccess('confirmPassword');
                        showFieldError('confirmPassword', 'Passwords do not match');
                    }
                } else {
                    confirmField.classList.remove('error', 'success');
                    clearFieldError('confirmPassword');
                    clearFieldSuccess('confirmPassword');
                }
            }

            function checkPasswordStrength(password) {
                let score = 0;
                const feedback = [];

                if (password.length >= passwordRequirements.minLength) {
                    score++;
                } else {
                    feedback.push(`At least ${passwordRequirements.minLength} characters`);
                }

                if (passwordRequirements.hasUppercase.test(password)) {
                    score++;
                } else {
                    feedback.push('One uppercase letter');
                }

                if (passwordRequirements.hasLowercase.test(password)) {
                    score++;
                } else {
                    feedback.push('One lowercase letter');
                }

                if (passwordRequirements.hasNumbers.test(password)) {
                    score++;
                } else {
                    feedback.push('One number');
                }

                if (passwordRequirements.hasSpecialChar.test(password)) {
                    score++;
                } else {
                    feedback.push('One special character');
                }

                return { score, feedback };
            }

            function updatePasswordStrengthUI(strength) {
                const strengthFill = document.getElementById('strength-fill');
                const strengthText = document.getElementById('strength-text');
                
                const percentage = (strength.score / 5) * 100;
                strengthFill.style.width = percentage + '%';
                
                if (strength.score <= 2) {
                    strengthFill.className = 'strength-fill strength-weak';
                    strengthText.textContent = 'Weak - Add: ' + strength.feedback.join(', ');
                } else if (strength.score <= 3) {
                    strengthFill.className = 'strength-fill strength-medium';
                    strengthText.textContent = 'Medium - Add: ' + strength.feedback.join(', ');
                } else {
                    strengthFill.className = 'strength-fill strength-strong';
                    strengthText.textContent = 'Strong password!';
                }
            }

            function updateSubmitButton() {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                const isValidForm = 
                    password && checkPasswordStrength(password).score >= 3 &&
                    confirmPassword && password === confirmPassword;
                
                resetBtn.disabled = !isValidForm;
            }

            function setLoadingState(loading) {
                if (loading) {
                    resetBtn.disabled = true;
                    btnText.style.display = 'none';
                    resetLoading.style.display = 'block';
                } else {
                    btnText.style.display = 'inline';
                    resetLoading.style.display = 'none';
                    updateSubmitButton();
                }
            }

            function clearErrors() {
                const errorElements = document.querySelectorAll('.error-message');
                const successElements = document.querySelectorAll('.success-message');
                const inputElements = document.querySelectorAll('input');
                
                errorElements.forEach(el => el.textContent = '');
                successElements.forEach(el => el.textContent = '');
                inputElements.forEach(el => el.classList.remove('error', 'success'));
            }

            function showFieldError(fieldName, message) {
                const errorElement = document.getElementById(fieldName + '-error');
                if (errorElement) {
                    errorElement.textContent = message;
                }
            }

            function showFieldSuccess(fieldName, message) {
                const successElement = document.getElementById(fieldName + '-success');
                if (successElement) {
                    successElement.textContent = message;
                }
            }

            function clearFieldError(fieldName) {
                const errorElement = document.getElementById(fieldName + '-error');
                if (errorElement) {
                    errorElement.textContent = '';
                }
            }

            function clearFieldSuccess(fieldName) {
                const successElement = document.getElementById(fieldName + '-success');
                if (successElement) {
                    successElement.textContent = '';
                }
            }

            function showMessage(message, type) {
                const messageContainer = document.getElementById('message-container');
                const messageElement = document.getElementById('message');
                
                messageElement.textContent = message;
                messageElement.className = `message ${type}`;
                messageContainer.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageContainer.style.display = 'none';
                }, 5000);
            }
        });
    </script>
</body>
</html>